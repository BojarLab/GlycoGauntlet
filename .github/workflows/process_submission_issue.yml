name: Process Submission from Issue

on:
  issues:
    types: [opened]

jobs:
  process:
    if: startsWith(github.event.issue.title, '[Submission]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Extract username
        id: extract
        run: |
          USERNAME=$(echo "${{ github.event.issue.body }}" | grep -A2 "GitHub Username" | tail -1 | xargs)
          if [ -z "$USERNAME" ]; then
            echo "Failed to extract username, using issue creator"
            USERNAME="${{ github.event.issue.user.login }}"
          fi
          echo "username=$USERNAME" >> $GITHUB_OUTPUT
          echo "Extracted username: $USERNAME"
      
      - name: Download attachments
        id: download
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const https = require('https');
            const issue = context.payload.issue;
            const attachmentRegex = /https:\/\/github\.com\/.*?\/files\/\d+\/[^\s)]+\.csv/g;
            const attachments = issue.body.match(attachmentRegex) || [];
            if (attachments.length === 0) {
              core.setFailed('No CSV attachments found in issue');
              return;
            }
            const dir = 'temp_submissions';
            fs.mkdirSync(dir, {recursive: true});
            for (const url of attachments) {
              const filename = path.basename(url.split('?')[0]);
              await new Promise((resolve, reject) => {
                https.get(url, {followAllRedirects: true}, (response) => {
                  if (response.statusCode === 302 || response.statusCode === 301) {
                    https.get(response.headers.location, (finalResponse) => {
                      const file = fs.createWriteStream(path.join(dir, filename));
                      finalResponse.pipe(file);
                      file.on('finish', () => file.close(resolve));
                    }).on('error', reject);
                  } else {
                    const file = fs.createWriteStream(path.join(dir, filename));
                    response.pipe(file);
                    file.on('finish', () => file.close(resolve));
                  }
                }).on('error', reject);
              });
            }
            return attachments.length;
      
      - name: Create submission structure
        run: |
          mkdir -p submissions/${{ steps.extract.outputs.username }}/public
          mv temp_submissions/*.csv submissions/${{ steps.extract.outputs.username }}/public/
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pandas openpyxl
      
      - name: Validate format
        id: validate
        run: |
          python validation/check_format.py submissions/${{ steps.extract.outputs.username }}/public || echo "validation_failed=true" >> $GITHUB_OUTPUT
      
      - name: Evaluate submission
        if: steps.validate.outputs.validation_failed != 'true'
        id: evaluate
        run: |
          pip install pandas numpy scipy openpyxl glycowork
          RESULT=$(python evaluation/evaluate_submission.py submissions/${{ steps.extract.outputs.username }}/public)
          SCORE=$(echo "$RESULT" | grep "Average F1:" | awk '{print $3}')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "$RESULT" > eval_result.txt
      
      - name: Update leaderboard
        if: steps.validate.outputs.validation_failed != 'true'
        run: |
          python leaderboard/update_leaderboard.py \
            "${{ steps.extract.outputs.username }}" \
            "${{ steps.evaluate.outputs.score }}" \
            "public"
      
      - name: Commit leaderboard changes
        if: steps.validate.outputs.validation_failed != 'true'
        run: |
          git config user.name "Competition Bot"
          git config user.email "bot@github.com"
          git add leaderboard/ submissions/
          git commit -m "Add submission from ${{ steps.extract.outputs.username }}" || echo "No changes"
          git push
      
      - name: Comment results on issue
        uses: actions/github-script@v6
        with:
          script: |
            const validation_failed = '${{ steps.validate.outputs.validation_failed }}' === 'true';
            let body;
            if (validation_failed) {
              body = '❌ Validation failed. Please check your file format and try again.';
            } else {
              const fs = require('fs');
              const result = fs.readFileSync('eval_result.txt', 'utf8');
              body = `## ✅ Submission Evaluated!\n\n\`\`\`\n${result}\n\`\`\`\n\nCheck the leaderboard: [leaderboard/public.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/leaderboard/public.md)`;
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      - name: Close issue
        if: steps.validate.outputs.validation_failed != 'true'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });